# Supabase Setup Guide

このドキュメントでは、AImoltプロジェクトを新規にSupabase環境で立ち上げるための手順を説明します。

## 1. プロジェクト作成 & 拡張機能の有効化

Supabaseダッシュボードにて新規プロジェクトを作成後、SQL Editorを開き、以下のSQLを実行して `pgvector` を有効化します。

```sql
-- Enable the pgvector extension to work with embedding vectors
create extension if not exists vector;
```

## 2. テーブル作成 (Create Tables)

以下のSQLを実行してテーブルを作成します。

### emotions
```sql
create table emotions (
  id bigint generated by default as identity primary key,
  user_id text not null,
  valence integer default 50,
  arousal integer default 50,
  dominance integer default 50,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);
```

### relationships
```sql
create table relationships (
  id bigint generated by default as identity primary key,
  user_id text not null,
  impression_summary text,
  mentor_focus text,
  affection_score integer default 0,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);
```

### conversations
```sql
create table conversations (
  id bigint generated by default as identity primary key,
  user_id text not null,
  user_message text not null,
  bot_response text,
  embedding halfvec(3072), -- Gemini embedding dimension (768 or 3072 depending on model, current setup uses 3072 via halfvec)
  created_at timestamp with time zone default timezone('utc'::text, now())
);
```

### transcripts
```sql
create table transcripts (
  id bigint generated by default as identity primary key,
  user_id text not null,
  text text not null,
  advice text,
  embedding halfvec(3072),
  created_at timestamp with time zone default timezone('utc'::text, now())
);
```

### system
```sql
create table system (
  key text primary key,
  value text,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

### posts
```sql
create table posts (
  id bigint generated by default as identity primary key,
  content text not null,
  next_scheduled_at timestamp with time zone,
  mode_id text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);
```
```

## 3. 関数 (RPCs) の作成

### Vector Search Functions

検索機能 (`AnalysisService`) で使用するベクトル検索関数を作成します。

**match_conversations**
```sql
create or replace function match_conversations (
  query_embedding halfvec(3072),
  match_threshold float,
  match_count int
)
returns table (
  id bigint,
  user_message text,
  bot_response text,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    conversations.id,
    conversations.user_message,
    conversations.bot_response,
    1 - (conversations.embedding <=> query_embedding) as similarity
  from conversations
  where 1 - (conversations.embedding <=> query_embedding) > match_threshold
  order by conversations.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

**match_transcripts**
```sql
create or replace function match_transcripts (
  query_embedding halfvec(3072),
  match_threshold float,
  match_count int
)
returns table (
  id bigint,
  text text,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    transcripts.id,
    transcripts.text,
    1 - (transcripts.embedding <=> query_embedding) as similarity
  from transcripts
  where 1 - (transcripts.embedding <=> query_embedding) > match_threshold
  order by transcripts.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

### Backup Schema Functions

動的バックアップ機能 (`BackupService`) で使用するスキーマ情報取得関数を作成します。
これらは `security definer` として設定し、API経由でスキーマ情報にアクセスできるようにします。

**get_all_tables**
```sql
create or replace function get_all_tables()
returns table (table_name text)
language sql
security definer
as $$
  select table_name
  from information_schema.tables
  where table_schema = 'public'
  and table_type = 'BASE TABLE';
$$;
```

**get_table_columns**
```sql
create or replace function get_table_columns(t_name text)
returns table (
  column_name text,
  data_type text,
  is_nullable text,
  column_default text
)
language sql
security definer
as $$
  select column_name, data_type, is_nullable, column_default
  from information_schema.columns
  where table_schema = 'public'
  and table_name = t_name;
$$;
```

## 4. Row Level Security (RLS)

本プロジェクトではサーバーサイド（Bot）から `service_role` キーまたは管理者権限のあるアカウントでアクセスする場合、RLSをバイパスできますが、`anon` キーを使用する場合やセキュリティを強化する場合は、RLSを有効化してください。

現状のコードベースでは `anon` キーを使用している可能性があるため、以下のポリシーを推奨します（全アクセス許可）。
※ 本番環境でユーザーごとのアクセス制御が必要な場合は、`user_id` に基づくポリシーに変更してください。

```sql
alter table emotions enable row level security;
create policy "Allow all access" on emotions for all using (true);

alter table relationships enable row level security;
create policy "Allow all access" on relationships for all using (true);

alter table conversations enable row level security;
create policy "Allow all access" on conversations for all using (true);

alter table transcripts enable row level security;
create policy "Allow all access" on transcripts for all using (true);

alter table system enable row level security;
create policy "Allow all access" on system for all using (true);

alter table posts enable row level security;
create policy "Allow all access" on posts for all using (true);
```

## 5. 環境変数の設定

Supabaseの `Project Settings` > `API` から URL と Anon Key を取得し、`.env` ファイルに設定してください。

```env
SUPABASE_URL=https://<your-project-id>.supabase.co
SUPABASE_KEY=<your-anon-key>
```
